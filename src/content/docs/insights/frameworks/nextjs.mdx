---
title: Next.js Integration
description: Automatic page view tracking for Next.js applications
---

The Next.js integration provides two approaches for page view tracking:
1. Middleware-based tracking for server-side integration
2. Hook-based tracking for client-side integration

Choose the approach that best fits your needs - you can use either or both depending on your requirements.

## Installation

```bash
npm install @thg-commerce/insights
```

## Middleware Approach

The middleware approach provides server-side tracking and is ideal for projects without caching layers.

```typescript
// middleware.ts
import { createMiddleware } from '@thg-commerce/insights/next';

export const middleware = createMiddleware({
  endpoint: 'https://api.example.com/events',
  debug: true
});

export const config = {
  matcher: '/:path*'
};
```

### Middleware Configuration Options

| Option | Type | Description |
|--------|------|-------------|
| `endpoint` | `string` | Required. API endpoint to send events to |
| `debug` | `boolean` | Optional. Enable debug logging |
| `sourceResolver` | `SourceResolver` | Optional. Custom source resolution |

### Route Matching

Control which routes are tracked using the matcher configuration:

```typescript
// Track all routes
export const config = {
  matcher: '/:path*'
};

// Track specific routes
export const config = {
  matcher: ['/blog/:path*', '/products/:path*']
};

// Exclude specific routes
export const config = {
  matcher: ['/((?!api|_next/static|favicon.ico).*)']
};
```

## Hook-based Approach

The hook-based approach provides client-side tracking and is ideal for projects with caching or where client-side tracking is preferred.

```typescript
// app/layout.tsx or _app.tsx
import { createTracker, usePageViewTracking } from '@thg-commerce/insights/next';

const tracker = createTracker({
  endpoint: 'https://api.example.com/events',
  debug: true
});

export default function RootLayout({ children }) {
  // Set up automatic page view tracking
  usePageViewTracking(tracker);

  return <>{children}</>;
}
```

### Hook Configuration Options

| Option | Type | Description |
|--------|------|-------------|
| `endpoint` | `string` | Required. API endpoint to send events to |
| `debug` | `boolean` | Optional. Enable debug logging |
| `sourceResolver` | `SourceResolver` | Optional. Custom source resolution |

The hook automatically tracks:
- Initial page load
- Client-side navigation
- Route changes in both pages and app directory

## Source Resolution

Both approaches use the request/window hostname by default. You can customize this by implementing a source resolver:

```typescript
class CustomSourceResolver implements SourceResolver {
  getCurrentSource() {
    return 'custom-source';
  }
}

// For middleware
export const middleware = createMiddleware({
  endpoint: 'https://api.example.com/events',
  sourceResolver: new CustomSourceResolver()
});

// For hook
const tracker = createTracker({
  endpoint: 'https://api.example.com/events',
  sourceResolver: new CustomSourceResolver()
});
```

## Event Structure

Both approaches send events in the same format:

```typescript
{
  type: 'page_view',
  path: string,    // Page path (e.g., '/blog/post-1')
  source: string   // Domain or custom source identifier
}
```

## Offline Support

Both approaches include:
- Automatic event queueing when offline
- Retry logic for failed sends
- Queue persistence across page reloads (hook-based only)

## Debug Output

When debug mode is enabled, you'll see logs in the console:

```
[THG Commerce Insights] Event queued: { type: 'page_view', path: '/blog/post-1' }
[THG Commerce Insights] Event sent successfully
[THG Commerce Insights] Device is offline, keeping events in queue
```

## THG Altitude Integration (Optional)

If you're using THG Altitude, you can use the built-in Altitude source resolver with either approach:

```typescript
import { AltitudeSourceResolver } from '@thg-commerce/insights/core';

// For middleware
export const middleware = createMiddleware({
  endpoint: 'https://api.example.com/events',
  sourceResolver: new AltitudeSourceResolver()
});

// For hook
const tracker = createTracker({
  endpoint: 'https://api.example.com/events',
  sourceResolver: new AltitudeSourceResolver()
});
```

## Performance Considerations

- Middleware: Non-blocking, no impact on Time to First Byte (TTFB)
- Hook: Minimal bundle size impact, lazy initialization
- Both: Asynchronous event sending